<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Existing Apps with srcdoc</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .test-section { border: 2px solid #007bff; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .log { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        iframe { width: 100%; height: 600px; border: 1px solid #ddd; margin-top: 10px; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        select { padding: 8px; font-size: 14px; margin: 10px 5px; }
    </style>
</head>
<body>
    <h1>Test Existing Apps with srcdoc Approach</h1>

    <div class="test-section">
        <h2>Select App to Test</h2>
        <p>This test loads apps using srcdoc + base tag (like the proposed ActionBridge modification)</p>

        <select id="app-select">
            <option value="">-- Select App --</option>
            <option value="test_suite">test_suite - ActionBridge test suite</option>
            <option value="notes_app">notes_app - Notes application</option>
            <option value="crypto_prices">crypto_prices - Crypto price tracker</option>
            <option value="self_bootstrap">self_bootstrap - Self-bootstrap app</option>
        </select>

        <button onclick="loadSelectedApp()">Load App with srcdoc</button>
        <button onclick="location.reload()">Reset</button>

        <div class="log" id="log"></div>
    </div>

    <div class="test-section">
        <h2>App Preview</h2>
        <div id="iframe-container"></div>
    </div>

    <script>
        function log(message, type = '') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span><br>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function loadSelectedApp() {
            const appSelect = document.getElementById('app-select');
            const appName = appSelect.value;

            if (!appName) {
                log('Please select an app first', 'error');
                return;
            }

            log('=== Loading App with srcdoc ===');
            log('App: ' + appName);

            try {
                // Step 1: Fetch index.html content with app query parameter
                // Get absolute path by replacing the current file with index.html
                const appUrl = 'index.html?app=' + encodeURIComponent(appName);
                const appUrl = basePath + 'index.html?app=' + encodeURIComponent(appName);
                log('Fetching: ' + appUrl);

                const response = await fetch(appUrl);
                if (!response.ok) {
                    throw new Error(`Failed to load ${appUrl}: HTTP ${response.status}`);
                }

                const htmlContent = await response.text();
                log('✅ Fetched HTML (' + htmlContent.length + ' bytes)', 'success');

                // Step 2: Inject <base> tag to fix relative paths
                const baseUrl = window.location.href.replace(/apps\/self_bootstrap\/[^/]*$/, '');
                log('Base URL: ' + baseUrl);

                const modifiedHTML = htmlContent.replace(
                    /<head>/i,
                    `<head><base href="${baseUrl}">`
                );

                log('✅ Injected <base> tag', 'success');

                // Step 3: Create iframe with srcdoc
                log('Creating iframe with srcdoc...');

                const container = document.getElementById('iframe-container');
                container.innerHTML = '';

                const iframe = document.createElement('iframe');
                iframe.sandbox = 'allow-scripts allow-same-origin allow-forms';
                iframe.srcdoc = modifiedHTML;
                iframe.style.width = '100%';
                iframe.style.height = '600px';
                iframe.style.border = '1px solid #ddd';

                iframe.onload = function() {
                    log('✅ Iframe loaded', 'success');

                    setTimeout(() => {
                        try {
                            const origin = iframe.contentWindow.location.origin || 'null';
                            log('Iframe origin: ' + origin);

                            // Check if app loaded
                            const url = iframe.contentWindow.location.href;
                            log('Iframe URL: ' + url);

                            log('');
                            log('=== App Loading Complete ===', 'success');
                            log('The app should be visible in the iframe above', 'success');
                            log('');
                            log('For test_suite app:', 'success');
                            log('1. Click "Run All Tests" button in the iframe');
                            log('2. Check if all tests pass');
                            log('3. Verify app works correctly with srcdoc');
                        } catch (e) {
                            log('Note: Cannot access iframe details: ' + e.message);
                            log('This is normal - app is running in sandboxed context');
                        }
                    }, 1000);
                };

                iframe.onerror = function(e) {
                    log('❌ Iframe load error: ' + e, 'error');
                };

                container.appendChild(iframe);
                log('Iframe created, waiting for load...');

            } catch (error) {
                log('❌ Error: ' + error.message, 'error');
            }
        }

        // Auto-load test_suite if requested
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('auto') === 'test_suite') {
            window.addEventListener('load', () => {
                document.getElementById('app-select').value = 'test_suite';
                setTimeout(loadSelectedApp, 500);
            });
        }
    </script>
</body>
</html>
